@model ApexDrive.Models.ViewModels.DashboardViewModel

@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Dashboard Overview";
}

<div class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
    <div>
        <div class="flex items-center gap-3 mb-2">
            <div class="bg-brand/10 p-2 rounded-lg">
                <i class="fa-solid fa-chart-line text-brand text-xl"></i>
            </div>
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">
                @Model.BranchName <span class="text-brand">Dashboard</span>
            </h1>
        </div>
        <p class="text-gray-500 flex items-center gap-2 px-1">
            <i class="fa-solid fa-location-dot text-brand"></i>
            @ViewBag.BranchName
        </p>
    </div>

    <form method="get" class="flex gap-3 mb-6">
        <input type="date"
               name="fromDate"
               value="@Model.FromDate?.ToString("yyyy-MM-dd")"
               class="border rounded-lg px-3 py-2 text-sm" />

        <input type="date"
               name="toDate"
               value="@Model.ToDate?.ToString("yyyy-MM-dd")"
               class="border rounded-lg px-3 py-2 text-sm" />

        <button class="bg-brand text-white px-4 rounded-lg font-bold text-sm">
            Filter Revenue
        </button>

        <a asp-action="Index"
           class="px-4 py-2 border rounded-lg text-sm text-gray-600">
            Clear
        </a>
    </form>


    <div class="flex gap-3">
        <button onclick="window.location.reload()" class="p-2.5 bg-white border border-gray-200 text-gray-600 rounded-xl hover:bg-gray-50 transition-all shadow-sm">
            <i class="fa-solid fa-rotate"></i>
        </button>
        <a asp-area="Admin" asp-controller="Bookings" asp-action="Index" class="bg-brand text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 hover:bg-blue-700 transition-all shadow-lg shadow-blue-100">
            <i class="fa-solid fa-plus text-xs"></i>
            New Booking
        </a>
    </div>
</div>

@if (Model.ReminderSummary.OverdueCount > 0 ||
     Model.ReminderSummary.DueTodayCount > 0 ||
     Model.ReminderSummary.UpcomingCount > 0)
{
    <div class="mb-8 bg-white border border-amber-100 rounded-2xl shadow-sm overflow-hidden">
        <div class="bg-amber-50 px-6 py-4 border-b border-amber-100 flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-amber-500 p-2 rounded-lg animate-pulse">
                    <i class="fa-solid fa-bell text-white text-sm"></i>
                </div>
                <div>
                    <h2 class="text-lg font-bold text-amber-900">Attention Required</h2>
                    <p class="text-xs text-amber-700 font-medium">Check vehicles that need immediate maintenance or document renewal.</p>
                </div>
            </div>

            <div class="flex flex-wrap gap-2">
                @if (Model.ReminderSummary.OverdueCount > 0)
                {
                    <a asp-area="Admin" asp-controller="Reminders" asp-action="Index" asp-route-onlyOverdue="true"
                       class="bg-red-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-red-600 transition-colors">
                        <i class="fa-solid fa-circle-exclamation"></i>
                        Overdue (@Model.ReminderSummary.OverdueCount)
                    </a>
                }
                @if (Model.ReminderSummary.DueTodayCount > 0)
                {
                    <a asp-area="Admin" asp-controller="Reminders" asp-action="Index"
                       asp-route-from="@DateTime.UtcNow.ToString("yyyy-MM-dd")"
                       asp-route-to="@DateTime.UtcNow.ToString("yyyy-MM-dd")"
                       class="bg-amber-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-amber-600 transition-colors">
                        <i class="fa-solid fa-calendar-day"></i>
                        Due Today (@Model.ReminderSummary.DueTodayCount)
                    </a>
                }
                @if (Model.ReminderSummary.UpcomingCount > 0)
                {
                    <a asp-area="Admin" asp-controller="Reminders" asp-action="Index"
                       asp-route-from="@DateTime.UtcNow.ToString("yyyy-MM-dd")"
                       asp-route-to="@DateTime.UtcNow.AddDays(3).ToString("yyyy-MM-dd")"
                       class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-blue-600 transition-colors">
                        <i class="fa-solid fa-calendar-lines"></i>
                        Upcoming (@Model.ReminderSummary.UpcomingCount)
                    </a>
                }
            </div>
        </div>

        @if (Model.ReminderSummary.UpcomingReminders?.Any() == true)
        {
            <div class="p-4 bg-white">
                <div class="space-y-2">
                    @foreach (var r in Model.ReminderSummary.UpcomingReminders)
                    {
                        <div class="flex items-center justify-between p-3 rounded-xl hover:bg-gray-50 transition-all border border-transparent hover:border-gray-100">
                            <div class="flex items-center gap-4">
                                <div class="bg-gray-100 h-10 w-10 rounded-full flex items-center justify-center text-gray-500">
                                    <i class="fa-solid fa-car text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-gray-900">@r.Car?.PlateNumber</p>
                                    <p class="text-xs text-gray-500">
                                        <span class="font-semibold text-brand uppercase">@r.Type</span> • Due @r.ReminderDate.ToString("dd MMM yyyy")
                                        @if (User.IsInRole("SuperAdmin"))
                                        {
                                            <span class="ml-1 text-gray-400">(@r.Branch?.BranchName)</span>
                                        }
                                    </p>
                                </div>
                            </div>
                            <a asp-area="Admin" asp-controller="Reminders" asp-action="Edit" asp-route-id="@r.ReminderId"
                               class="bg-gray-100 text-gray-700 h-8 w-8 flex items-center justify-center rounded-lg hover:bg-brand hover:text-white transition-all">
                                <i class="fa-solid fa-arrow-right text-xs"></i>
                            </a>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="group bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:border-brand/30 transition-all">
        <div class="flex justify-between items-start mb-4">
            <div class="bg-blue-50 text-brand p-3 rounded-xl group-hover:bg-brand group-hover:text-white transition-all">
                <i class="fa-solid fa-car-rear text-xl"></i>
            </div>
            <a asp-controller="Cars" asp-action="Index" class="text-xs font-bold text-gray-400 hover:text-brand uppercase tracking-tighter">View All</a>
        </div>
        <p class="text-gray-500 text-sm font-medium">Total Fleet</p>
        <h2 class="text-3xl font-black text-gray-900 mt-1">@Model.TotalCars</h2>
    </div>

    <div class="group bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:border-emerald-300 transition-all">
        <div class="flex justify-between items-start mb-4">
            <div class="bg-emerald-50 text-emerald-600 p-3 rounded-xl group-hover:bg-emerald-600 group-hover:text-white transition-all">
                <i class="fa-solid fa-key text-xl"></i>
            </div>
            <a asp-controller="Bookings" asp-action="Index" class="text-xs font-bold text-gray-400 hover:text-emerald-600 uppercase tracking-tighter">Manage</a>
        </div>
        <p class="text-gray-500 text-sm font-medium">Active Rentals</p>
        <h2 class="text-3xl font-black text-gray-900 mt-1">@Model.ActiveBookings</h2>
    </div>

    <div class="group bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:border-amber-300 transition-all">
        <div class="flex justify-between items-start mb-4">
            <div class="bg-amber-50 text-amber-600 p-3 rounded-xl group-hover:bg-amber-600 group-hover:text-white transition-all">
                <i class="fa-solid fa-clock-rotate-left text-xl"></i>
            </div>
            <a asp-controller="Reminders" asp-action="Index" class="text-xs font-bold text-gray-400 hover:text-amber-600 uppercase tracking-tighter">Schedules</a>
        </div>
        <p class="text-gray-500 text-sm font-medium">Pending Tasks</p>
        <h2 class="text-3xl font-black text-gray-900 mt-1">@Model.UpcomingReminders</h2>
    </div>

    <div class="group bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:border-indigo-300 transition-all">
        <div class="flex justify-between items-start mb-4">
            <div class="bg-indigo-50 text-indigo-600 p-3 rounded-xl group-hover:bg-indigo-600 group-hover:text-white transition-all">
                <i class="fa-solid fa-screwdriver-wrench text-xl"></i>
            </div>
            <a asp-controller="Maintenance" asp-action="Index" class="text-xs font-bold text-gray-400 hover:text-indigo-600 uppercase tracking-tighter">History</a>
        </div>
        <p class="text-gray-500 text-sm font-medium">Maintenance Done</p>
        <h2 class="text-3xl font-black text-gray-900 mt-1">@Model.CompletedMaintenances</h2>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <div class="lg:col-span-2 bg-white p-8 rounded-3xl shadow-sm border border-gray-100 relative overflow-hidden">
        <div class="absolute top-0 right-0 p-8 opacity-5">
            <i class="fa-solid fa-sack-dollar text-8xl"></i>
        </div>
        <div class="relative z-10">
            <p class="text-gray-500 font-bold uppercase tracking-widest text-xs mb-2">
                @if (Model.FromDate.HasValue && Model.ToDate.HasValue)
                {
                    <span>
                        Revenue from
                        @Model.FromDate.Value.ToString("dd MMM yyyy")
                        to
                        @Model.ToDate.Value.ToString("dd MMM yyyy")
                    </span>
                }
                else
                {
                    <span>Total Revenue</span>
                }

            </p>

            <h2 class="text-5xl font-black text-gray-900 mb-4">
                @Model.TotalRevenue.ToString("C")
            </h2>
            <div class="flex items-center gap-2 text-emerald-600 font-bold text-sm bg-emerald-50 w-fit px-3 py-1 rounded-full">
                <i class="fa-solid fa-chart-line"></i>
                @if (Model.FromDate.HasValue || Model.ToDate.HasValue)
                {
                    <span>Filtered Result</span>
                }
                else
                {
                    <span>Lifetime Earnings</span>
                }


            </div>
        </div>
    </div>

    <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100">
        <h2 class="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
            <i class="fa-solid fa-wrench text-gray-400"></i>
            Quick Maintenance
        </h2>
        @if (Model.CompletedMaintenances == 0)
        {
            <div class="text-center py-8">
                <i class="fa-solid fa-inbox text-gray-200 text-4xl mb-3"></i>
                <p class="text-gray-400 text-sm">No recent records.</p>
            </div>
        }
        else
        {
            <div class="space-y-4">
                <p class="text-gray-600 text-sm leading-relaxed">
                    Showing last <span class="font-bold">@Model.CompletedMaintenances</span> records for <span class="text-brand">@Model.BranchName</span>.
                </p>
                <a asp-controller="Maintenance" asp-action="Index" class="block text-center py-3 bg-gray-50 text-gray-600 rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-gray-100 transition-all border border-gray-100">
                    Full Log History
                </a>
            </div>
        }
    </div>
</div>

<div class="flex items-center gap-4 mb-6">
    <div class="h-px bg-gray-200 flex-1"></div>
    <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest px-4">Performance Analytics</h2>
    <div class="h-px bg-gray-200 flex-1"></div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-20">
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
        <div class="flex items-center justify-between mb-6">
            <h3 class="font-bold text-gray-900 flex items-center gap-2">
                <i class="fa-solid fa-calendar-check text-brand"></i>
                Monthly Bookings
            </h3>
            <span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold uppercase">Real-time</span>
        </div>
        <canvas id="bookingsChart" height="200"></canvas>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
        <div class="flex items-center justify-between mb-6">
            <h3 class="font-bold text-gray-900 flex items-center gap-2">
                <i class="fa-solid fa-toolbox text-emerald-500"></i>
                Service Frequency
            </h3>
            <span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold uppercase">Maintenance</span>
        </div>
        <canvas id="maintenanceChart" height="200"></canvas>
    </div>

    @if (User.IsInRole("SuperAdmin"))
    {
        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 lg:col-span-2">
            <h3 class="font-bold text-gray-900 mb-6 flex items-center gap-2">
                <i class="fa-solid fa-city text-indigo-500"></i>
                Fleet Distribution by Branch
            </h3>
            <div class="max-w-md mx-auto">
                <canvas id="carsChart" height="250"></canvas>
            </div>
        </div>
    }

    @if (User.IsInRole("SuperAdmin"))
    {
        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 lg:col-span-2">
            <h3 class="font-bold text-gray-900 mb-6 flex items-center gap-2">
                <i class="fa-solid fa-sack-dollar text-emerald-600"></i>
                Revenue by Branch
            </h3>
            <canvas id="revenueChart" height="250"></canvas>
        </div>
    }

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            const url = '@Url.Action("GetDashboardData", "Dashboard", new { area = "Admin" })';

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error("Failed to load dashboard data");
                    return response.json();
                })
                .then(data => {

                    /* ===============================
                       📊 Monthly Bookings Chart
                       =============================== */
                    if (data.monthlyBookings?.length) {

                        const labels = data.monthlyBookings.map(x => x.month);
                        const values = data.monthlyBookings.map(x => x.count);

                        new Chart(document.getElementById('bookingsChart'), {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Bookings',
                                    data: values,
                                    tension: 0.4,
                                    fill: true,
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { display: false }
                                }
                            }
                        });
                    }

                    /* ===============================
                       🧰 Maintenance Frequency Chart
                       =============================== */
                    if (data.maintenanceStats?.length) {

                        const labels = data.maintenanceStats.map(x => x.month);
                        const values = data.maintenanceStats.map(x => x.count);

                        new Chart(document.getElementById('maintenanceChart'), {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Maintenance',
                                    data: values,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { display: false }
                                }
                            }
                        });
                    }

                    /* ===============================
                       🚗 Cars Per Branch (SuperAdmin)
                       =============================== */
                    if (data.carsPerBranch?.length && document.getElementById('carsChart')) {

                        const labels = data.carsPerBranch.map(x => x.branchName);
                        const values = data.carsPerBranch.map(x => x.carCount);

                        new Chart(document.getElementById('carsChart'), {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: values,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true
                            }
                        });
                    }

                    /* ===============================
                       💰 Revenue Per Branch (THB)
                       =============================== */
                    if (data.revenuePerBranch?.length && document.getElementById('revenueChart')) {

                        const labels = data.revenuePerBranch.map(x => x.branchName);
                        const values = data.revenuePerBranch.map(x => x.revenue);

                        new Chart(document.getElementById('revenueChart'), {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Revenue (THB)',
                                    data: values,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: ctx => `฿ ${ctx.raw.toLocaleString()}`
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        ticks: {
                                            callback: value => `฿ ${value.toLocaleString()}`
                                        }
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error("Dashboard error:", error);
                });
        });
    </script>
}

