@model ApexDrive.Models.ViewModels.DashboardViewModel

@{
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Dashboard";
}

<h1 class="text-2xl font-bold text-brand mb-6">
    📊 @Model.BranchName Dashboard
</h1>
<p class="text-sm text-gray-500 mb-4">🏢 @ViewBag.BranchName</p>


@if (Model.ReminderSummary.OverdueCount > 0 ||
     Model.ReminderSummary.DueTodayCount > 0 ||
     Model.ReminderSummary.UpcomingCount > 0)
{
    <div class="mb-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-xl shadow-sm">
        <div class="flex flex-wrap justify-between items-start gap-4">
            <div>
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    ⚠️ Reminder Summary
                </h2>
                <p class="text-sm text-gray-500">
                    Stay ahead — check vehicles that need attention soon.
                </p>
            </div>

            <div class="flex gap-2">
                @if (Model.ReminderSummary.OverdueCount > 0)
                {
                    <a asp-area="Admin" asp-controller="Reminders" asp-action="Index" asp-route-onlyOverdue="true"
                       class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-medium">
                        🔴 Overdue (@Model.ReminderSummary.OverdueCount)
                    </a>
                }
                @if (Model.ReminderSummary.DueTodayCount > 0)
                {
                    <a asp-area="Admin" asp-controller="Reminders" asp-action="Index"
                       asp-route-from="@DateTime.UtcNow.ToString("yyyy-MM-dd")"
                       asp-route-to="@DateTime.UtcNow.ToString("yyyy-MM-dd")"
                       class="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-sm font-medium">
                        🟡 Due Today (@Model.ReminderSummary.DueTodayCount)
                    </a>
                }
                @if (Model.ReminderSummary.UpcomingCount > 0)
                {
                    <a asp-area="Admin" asp-controller="Reminders" asp-action="Index"
                       asp-route-from="@DateTime.UtcNow.ToString("yyyy-MM-dd")"
                       asp-route-to="@DateTime.UtcNow.AddDays(3).ToString("yyyy-MM-dd")"
                       class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">
                        🔵 Upcoming (@Model.ReminderSummary.UpcomingCount)
                    </a>
                }
            </div>
        </div>

        @if (Model.ReminderSummary.UpcomingReminders?.Any() == true)
        {
            <ul class="mt-3 text-sm text-gray-700 divide-y divide-gray-200">
                @foreach (var r in Model.ReminderSummary.UpcomingReminders)
                {
                    <li class="py-2 flex justify-between items-center">
                        <div>
                            <strong>@r.Car?.PlateNumber</strong>
                            <span class="text-gray-500"> — @r.Type on @r.ReminderDate.ToString("dd MMM")</span>

                            @if (User.IsInRole("SuperAdmin"))
                            {
                                <span class="text-gray-400 text-xs ml-2">(@r.Branch?.BranchName)</span>
                            }
                        </div>
                        <a asp-area="Admin" asp-controller="Reminders" asp-action="Edit" asp-route-id="@r.ReminderId"
                           class="text-blue-600 hover:underline text-sm">View</a>
                    </li>
                }
            </ul>
        }
    </div>
}

<!-- Overview Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <!-- Total Cars -->
    <div class="bg-white p-6 rounded-xl shadow hover:shadow-md transition">
        <p class="text-gray-500 text-sm">Total Cars</p>
        <h2 class="text-3xl font-bold text-brand mt-2">@Model.TotalCars</h2>
    </div>

    <!-- Active Bookings -->
    <div class="bg-white p-6 rounded-xl shadow hover:shadow-md transition">
        <p class="text-gray-500 text-sm">Active Bookings</p>
        <h2 class="text-3xl font-bold text-brand mt-2">@Model.ActiveBookings</h2>
    </div>

    <!-- Upcoming Reminders -->
    <div class="bg-white p-6 rounded-xl shadow hover:shadow-md transition">
        <p class="text-gray-500 text-sm">Upcoming Reminders (7 Days)</p>
        <h2 class="text-3xl font-bold text-brand mt-2">@Model.UpcomingReminders</h2>
    </div>

    <!-- Completed Maintenances -->
    <div class="bg-white p-6 rounded-xl shadow hover:shadow-md transition">
        <p class="text-gray-500 text-sm">Completed Maintenances</p>
        <h2 class="text-3xl font-bold text-brand mt-2">@Model.CompletedMaintenances</h2>
    </div>
</div>

<!-- Optional Revenue Section -->
<div class="bg-white p-6 rounded-xl shadow hover:shadow-md transition mb-6">
    <p class="text-gray-500 text-sm">Total Revenue</p>
    <h2 class="text-3xl font-bold text-green-600 mt-2">
        @Model.TotalRevenue.ToString("C")
    </h2>
</div>

<!-- Placeholder for Recent Maintenance (future use) -->
<div class="bg-white p-6 rounded-xl shadow-md">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">🧰 Recent Maintenance</h2>

    @if (Model.CompletedMaintenances == 0)
    {
        <p class="text-gray-400 text-center py-4">No maintenance records yet.</p>
    }
    else
    {
        <p class="text-gray-600 text-sm">
            Showing last @Model.CompletedMaintenances maintenance records for <b>@Model.BranchName</b>.
        </p>
    }
</div>

<hr class="my-10" />

<h2 class="text-xl font-semibold text-gray-800 mb-4">📈 Analytics Overview</h2>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Monthly Bookings -->
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="font-semibold text-gray-700 mb-3">📅 Monthly Bookings</h3>
        <canvas id="bookingsChart" height="200"></canvas>
    </div>

    <!-- Maintenance Trend -->
    <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="font-semibold text-gray-700 mb-3">🧰 Maintenance Frequency</h3>
        <canvas id="maintenanceChart" height="200"></canvas>
    </div>

    @if (User.IsInRole("SuperAdmin"))
    {
        <!-- Cars Per Branch -->
        <div class="bg-white p-6 rounded-xl shadow-sm lg:col-span-2">
            <h3 class="font-semibold text-gray-700 mb-3">🚗 Cars per Branch</h3>
            <canvas id="carsChart" height="120"></canvas>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        async function loadDashboardCharts() {
            const response = await fetch('/Admin/Dashboard/GetDashboardData');
            const data = await response.json();

            // Monthly Bookings
            const bookingLabels = data.monthlyBookings.map(b => b.Month);
            const bookingValues = data.monthlyBookings.map(b => b.Count);

            new Chart(document.getElementById('bookingsChart'), {
                type: 'line',
                data: {
                    labels: bookingLabels,
                    datasets: [{
                        label: 'Bookings',
                        data: bookingValues,
                        borderColor: '#0F62FE',
                        backgroundColor: 'rgba(15,98,254,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });

            // Maintenance
            const maintLabels = data.maintenanceStats.map(m => m.Month);
            const maintValues = data.maintenanceStats.map(m => m.Count);

            new Chart(document.getElementById('maintenanceChart'), {
                type: 'bar',
                data: {
                    labels: maintLabels,
                    datasets: [{
                        label: 'Services',
                        data: maintValues,
                        backgroundColor: '#22C55E'
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });

            // Cars per Branch (SuperAdmin)
            if (data.carsPerBranch) {
                const branchLabels = data.carsPerBranch.map(b => b.BranchName);
                const carCounts = data.carsPerBranch.map(b => b.CarCount);

                new Chart(document.getElementById('carsChart'), {
                    type: 'pie',
                    data: {
                        labels: branchLabels,
                        datasets: [{
                            label: 'Cars',
                            data: carCounts,
                            backgroundColor: ['#0F62FE', '#FACC15', '#22C55E', '#EF4444']
                        }]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
        }

        loadDashboardCharts();
    </script>
}

